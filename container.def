Bootstrap: docker
From: ubuntu:22.04

%files
    conda/conda_env.yml conda_env.yml

%post
    export DEBIAN_FRONTEND=noninteractive
    export TZ=Europe/Madrid

    apt update && apt install -y tzdata
    # System setup
    apt update && apt install -y \
        python3 python3-pip python3-dev \
        build-essential cmake ninja-build git \
        libeigen3-dev libjsoncpp-dev \
        libopenblas-dev liblapack-dev \
        libboost-all-dev libopencv-dev curl

    # Conan
    curl -L  https://github.com/conan-io/conan/releases/download/2.17.0/conan-2.17.0-amd64.deb -o conan.deb
    dpkg -i conan.deb
    conan profile detect

    # Optional: install Conda
    apt install -y wget bzip2
    curl -L https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -o miniconda.sh
    bash miniconda.sh -b -p /opt/conda
    export PATH=/opt/conda/bin:$PATH
    conda init

    # Create environment and install deps
    conda env create -f conda_env.yml

%environment
    export PATH=/opt/conda/bin:$PATH
    export CONDA_ENV_NAME="accurate_ri_env"
    source /opt/conda/etc/profile.d/conda.sh
    conda activate "$CONDA_ENV_NAME"

%runscript
    exec python3 "$@"
